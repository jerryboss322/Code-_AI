<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeAi ‚Ä¢ Your Local Programming Genius</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* ‚îÄ‚îÄ CANVAS LAYERS ‚îÄ‚îÄ */
        #bg-canvas{position:fixed;inset:0;z-index:0;pointer-events:none}
        .bg-grid{position:fixed;inset:0;z-index:0;pointer-events:none;background-image:linear-gradient(rgba(255,23,68,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(255,23,68,.04) 1px,transparent 1px);background-size:46px 46px;mask-image:radial-gradient(ellipse 80% 80% at 50% 50%,black,transparent)}
        .bg-vig{position:fixed;inset:0;z-index:0;pointer-events:none;background:radial-gradient(ellipse at center,transparent 40%,rgba(7,0,13,.75) 100%)}

        /* ‚îÄ‚îÄ BASE ‚îÄ‚îÄ */
        *,*::before,*::after{box-sizing:border-box}
        body{background:#07000d!important;color:#f0d8f8!important;font-family:'Outfit',sans-serif!important;-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent}

        /* ‚îÄ‚îÄ TAILWIND COLOR OVERRIDES ‚îÄ‚îÄ */
        .bg-zinc-950{background:#07000d!important}
        .bg-zinc-900{background:rgba(14,0,21,.97)!important}
        .bg-zinc-800{background:rgba(22,0,32,.9)!important}
        .bg-zinc-700{background:rgba(36,0,50,.9)!important}
        .border-zinc-800{border-color:rgba(255,23,68,.14)!important}
        .border-zinc-700{border-color:rgba(255,23,68,.22)!important}
        .text-zinc-100{color:#f0d8f8!important}
        .text-zinc-400{color:#9050b0!important}
        .text-zinc-500{color:#5a2870!important}
        .text-white{color:#fff!important}
        .text-blue-400{color:#ff4569!important}
        .text-amber-400{color:#e040fb!important}
        .text-emerald-400{color:#00e676!important;text-shadow:0 0 8px #00e676;animation:dotP 2s ease-in-out infinite}
        @keyframes dotP{0%,100%{opacity:1}50%{opacity:.4}}
        .text-red-400{color:#ff4060!important}
        .hover\:text-red-400:hover{color:#ff4060!important}
        .hover\:text-red-500:hover{color:#ff1744!important}
        .hover\:text-white:hover{color:#fff!important}
        .accent-blue-500{accent-color:#ff1744!important}
        .bg-blue-600{background:linear-gradient(135deg,#ff1744,#ff2d78)!important;box-shadow:0 0 18px rgba(255,23,68,.4)!important}
        .hover\:bg-blue-500:hover{background:linear-gradient(135deg,#ff3d5a,#ff4d88)!important;box-shadow:0 0 28px rgba(255,23,68,.55)!important}
        .focus\:border-blue-500:focus{border-color:rgba(255,23,68,.5)!important;box-shadow:0 0 0 3px rgba(255,23,68,.08)!important}
        .shadow-blue-500\/30{box-shadow:0 8px 24px rgba(255,23,68,.3)!important}
        .hover\:bg-zinc-700:hover{background:rgba(36,0,50,.85)!important}
        .hover\:bg-zinc-800:hover{background:rgba(26,0,38,.9)!important}
        .bg-\[radial-gradient\(\#27272a_1px\,transparent_1px\)\]{background-image:radial-gradient(rgba(255,23,68,.07) 1px,transparent 1px)!important}
        .bg-black\/70{background:rgba(0,0,0,.78)!important;backdrop-filter:blur(6px)}

        /* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
        #sidebar{border-right:1px solid rgba(255,23,68,.14)!important;position:relative;z-index:10;backdrop-filter:blur(20px)}
        #sidebar::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#ff1744,#e040fb,transparent);animation:edgeS 3s ease-in-out infinite}
        @keyframes edgeS{0%,100%{opacity:.4}50%{opacity:1}}
        #sidebar::after{content:'';position:absolute;top:-80px;left:-80px;width:240px;height:240px;background:radial-gradient(circle,rgba(255,23,68,.07),transparent 70%);pointer-events:none}

        /* Logo icon */
        .from-blue-500.to-cyan-400{background:linear-gradient(135deg,#1a0022,#2a000a)!important;border:1px solid rgba(255,23,68,.45)!important;box-shadow:0 0 18px rgba(255,23,68,.25)!important;animation:iconP 3s ease-in-out infinite}
        @keyframes iconP{0%,100%{box-shadow:0 0 18px rgba(255,23,68,.25)}50%{box-shadow:0 0 32px rgba(255,23,68,.5)}}

        /* Logo font */
        .logo-font{font-family:'Rajdhani',sans-serif!important;letter-spacing:2px!important;background:linear-gradient(120deg,#fff 0%,#ff4569 50%,#ea80fc 100%)!important;-webkit-background-clip:text!important;-webkit-text-fill-color:transparent!important;background-clip:text!important;background-size:200% auto!important;animation:shimmer 4s linear infinite!important}
        @keyframes shimmer{0%{background-position:0% center}100%{background-position:200% center}}

        /* New chat btn */
        .rounded-3xl.border.border-zinc-700{border-color:rgba(255,23,68,.25)!important;color:#ff4569!important;background:linear-gradient(135deg,rgba(255,23,68,.08),rgba(224,64,251,.06))!important;transition:all .25s!important}
        .rounded-3xl.border.border-zinc-700:hover{border-color:rgba(255,23,68,.45)!important;background:linear-gradient(135deg,rgba(255,23,68,.16),rgba(224,64,251,.12))!important;box-shadow:0 0 20px rgba(255,23,68,.18)!important;transform:translateY(-1px)!important}

        /* History items */
        #chat-history>div{border-radius:8px!important;border:1px solid transparent!important;transition:all .15s!important;position:relative;overflow:hidden}
        #chat-history>div.bg-zinc-800{background:rgba(255,23,68,.08)!important;border-color:rgba(255,23,68,.2)!important}
        #chat-history>div.bg-zinc-800::before{content:'';position:absolute;left:0;top:15%;bottom:15%;width:2px;background:#ff1744;border-radius:0 2px 2px 0;box-shadow:0 0 8px rgba(255,23,68,.6)}

        /* Topbar line */
        .h-14.bg-zinc-900{position:relative;z-index:10}
        .h-14.bg-zinc-900::after{content:'';position:absolute;bottom:0;left:8%;right:8%;height:1px;background:linear-gradient(90deg,transparent,#ff1744,#e040fb,transparent);opacity:.5}

        /* Message bubbles */
        .max-w-\[80\%\].bg-blue-600{background:linear-gradient(135deg,rgba(255,23,68,.18),rgba(224,64,251,.1))!important;border:1px solid rgba(255,23,68,.25)!important;color:#fff!important;border-radius:4px 18px 18px 18px!important}
        .max-w-\[80\%\].bg-zinc-800{background:rgba(18,0,26,.85)!important;border:1px solid rgba(255,23,68,.1)!important;border-radius:18px 18px 18px 4px!important}

        /* Welcome icon */
        .w-24.h-24{background:linear-gradient(135deg,rgba(255,23,68,.12),rgba(224,64,251,.1))!important;border:1px solid rgba(255,23,68,.3)!important;box-shadow:0 0 50px rgba(255,23,68,.15)!important;animation:floatI 4s ease-in-out infinite}
        @keyframes floatI{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}

        /* Welcome quick cards */
        .bg-zinc-900.hover\:bg-zinc-800.border.border-zinc-700.rounded-3xl{background:rgba(14,0,21,.9)!important;border:1px solid rgba(255,23,68,.14)!important;border-radius:12px!important;transition:all .22s!important}
        .bg-zinc-900.hover\:bg-zinc-800.border.border-zinc-700.rounded-3xl:hover{border-color:rgba(255,23,68,.38)!important;background:rgba(255,23,68,.05)!important;transform:translateY(-2px)!important;box-shadow:0 8px 28px rgba(255,23,68,.12)!important}

        /* Input */
        #user-input{background:rgba(18,0,26,.9)!important;border:1px solid rgba(255,23,68,.2)!important;color:#f0d8f8!important;border-radius:14px!important;font-family:'Outfit',sans-serif!important;transition:border-color .25s,box-shadow .25s!important}
        #user-input::placeholder{color:#4a2060!important}
        #user-input:focus{border-color:rgba(255,23,68,.5)!important;box-shadow:0 0 0 3px rgba(255,23,68,.08),0 0 24px rgba(255,23,68,.07)!important;outline:none!important}

        /* Send button */
        button.bg-blue-600.w-10{background:linear-gradient(135deg,#ff1744,#ff2d78)!important;border-radius:10px!important;box-shadow:0 0 18px rgba(255,23,68,.4)!important;transition:all .2s!important}
        button.bg-blue-600.w-10:hover{transform:scale(1.08)!important;box-shadow:0 0 30px rgba(255,23,68,.6)!important}

        /* Settings modal */
        #settings-modal>div{background:rgba(14,0,21,.99)!important;border:1px solid rgba(255,23,68,.22)!important;border-radius:18px!important;position:relative;overflow:hidden}
        #settings-modal>div::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#ff1744,#e040fb,transparent)}
        #settings-modal input[type="range"]{accent-color:#ff1744!important}
        #settings-modal input[type="number"]{background:rgba(255,23,68,.05)!important;border:1px solid rgba(255,23,68,.2)!important;border-radius:8px!important;color:#f0d8f8!important}
        #settings-modal input[type="number"]:focus{border-color:rgba(255,23,68,.45)!important;outline:none!important}
        #settings-modal button{border:1px solid rgba(255,23,68,.22)!important;border-radius:10px!important;background:transparent!important;color:#9050b0!important;transition:all .2s!important}
        #settings-modal button:hover{border-color:#ff1744!important;color:#ff4569!important;background:rgba(255,23,68,.05)!important}

        /* Scrollbars */
        .chat-container{scrollbar-width:thin!important;scrollbar-color:rgba(255,23,68,.2) transparent!important}
        .chat-container::-webkit-scrollbar{width:4px!important}
        .chat-container::-webkit-scrollbar-thumb{background:rgba(255,23,68,.2)!important;border-radius:4px!important}

        /* Typing cursor */
        .typing-cursor{display:inline-block;width:2px;height:1.1em;background:#e040fb!important;vertical-align:middle;animation:blink .8s step-end infinite;box-shadow:0 0 6px rgba(224,64,251,.6)}
        @keyframes blink{50%{opacity:0}}

        /* Message slide in */
        .message-bubble{animation:msgS .3s ease forwards}
        @keyframes msgS{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

        /* Code blocks */
        .prose pre{background:#060008!important;border:1px solid rgba(255,23,68,.15)!important;border-radius:10px!important;position:relative}
        .prose pre::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#ff1744,#e040fb,transparent);opacity:.5;border-radius:10px 10px 0 0}
        code{font-family:'JetBrains Mono',monospace!important}
        .copy-btn{background:rgba(255,23,68,.1)!important;border:1px solid rgba(255,23,68,.25)!important;color:#ff4569!important;border-radius:6px!important}
        .copy-btn:hover{background:rgba(255,23,68,.2)!important;box-shadow:0 0 10px rgba(255,23,68,.2)!important}

        @media(max-width:768px){#sidebar{z-index:50!important}}
    </style>
    <script>
    document.addEventListener('DOMContentLoaded',()=>{
        const c=document.createElement('canvas');c.id='bg-canvas';document.body.prepend(c);
        const g=document.createElement('div');g.className='bg-grid';document.body.prepend(g);
        const v=document.createElement('div');v.className='bg-vig';document.body.prepend(v);
        const ctx=c.getContext('2d');let W,H;const N=55,D2=110*110;let pts=[];
        function resize(){W=c.width=innerWidth;H=c.height=innerHeight}
        function mk(){return{x:Math.random()*W,y:Math.random()*H,vx:(Math.random()-.5)*.26,vy:(Math.random()-.5)*.26,r:Math.random()*1.3+.4,op:Math.random()*.4+.1,t:Math.random()*6.28}}
        function draw(){
            ctx.clearRect(0,0,W,H);
            pts.forEach(p=>{p.x+=p.vx;p.y+=p.vy;p.t+=.018;if(p.x<0)p.x=W;if(p.x>W)p.x=0;if(p.y<0)p.y=H;if(p.y>H)p.y=0;const a=p.op*(.65+.35*Math.sin(p.t));ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,6.28);ctx.fillStyle=`rgba(255,23,68,${a})`;ctx.fill()});
            for(let i=0;i<pts.length-1;i++)for(let j=i+1;j<pts.length;j++){const dx=pts[i].x-pts[j].x,dy=pts[i].y-pts[j].y,d=dx*dx+dy*dy;if(d<D2){const f=1-d/D2;ctx.beginPath();ctx.moveTo(pts[i].x,pts[i].y);ctx.lineTo(pts[j].x,pts[j].y);ctx.strokeStyle=(i+j)%3?`rgba(255,23,68,${.07*f})`:`rgba(224,64,251,${.05*f})`;ctx.lineWidth=.5;ctx.stroke()}}
            requestAnimationFrame(draw)
        }
        window.addEventListener('resize',resize);resize();pts=Array.from({length:N},mk);draw();
    });
    </script>
</head>
<body class="bg-zinc-950 text-zinc-100 flex h-screen overflow-hidden font-sans">
    <!-- SIDEBAR -->
    <div id="sidebar" class="w-72 bg-zinc-900 border-r border-zinc-800 flex flex-col transition-all duration-300 md:translate-x-0">
        <!-- Header -->
        <div class="p-4 border-b border-zinc-800 flex items-center gap-3">
            <div class="w-9 h-9 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-2xl flex items-center justify-center text-white font-bold text-2xl shadow-inner">ü§ñ</div>
            <div>
                <h1 class="logo-font text-3xl font-semibold tracking-tighter text-white">CodeAi</h1>
                <p class="text-[10px] text-zinc-500 -mt-1">GPT-OSS 20B ‚Ä¢ Groq Cloud</p>
            </div>
        </div>

        <!-- New Chat -->
        <div class="p-4">
            <button onclick="newChat()" 
                    class="w-full flex items-center justify-center gap-3 bg-zinc-800 hover:bg-zinc-700 transition-colors text-white font-medium py-3.5 px-6 rounded-3xl border border-zinc-700">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                NEW CHAT
            </button>
        </div>

        <!-- Chat History -->
        <div class="flex-1 overflow-y-auto px-3 chat-container" id="chat-history">
            <!-- Populated by JS -->
        </div>

        <!-- Footer -->
        <div class="p-4 border-t border-zinc-800 text-xs text-zinc-500 flex items-center gap-2">
            <div class="flex-1">Built for 8GB RAM ‚Ä¢ Fully offline</div>
            <button onclick="clearAllChats()" class="hover:text-red-400 transition-colors">Clear all</button>
        </div>
    </div>

    <!-- MAIN CHAT AREA -->
    <div class="flex-1 flex flex-col min-w-0">
        <!-- Top Bar -->
        <div class="h-14 bg-zinc-900 border-b border-zinc-800 px-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="md:hidden text-zinc-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <div class="flex items-center gap-2">
                    <span class="text-emerald-400 text-xs font-mono">‚óè</span>
                    <span class="text-sm font-medium text-zinc-400">Mistral 7B Q4</span>
                </div>
            </div>
            
            <div class="flex items-center gap-6 text-sm">
                <div onclick="showSettings()" class="cursor-pointer flex items-center gap-1.5 text-zinc-400 hover:text-white transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 002.573-1.066c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 00.817 1.194 1.724 1.724 0 01.817 1.194c-.94 1.543.827 3.31 2.37 2.37 1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 01-2.573 1.066 1.724 1.724 0 01-.817 1.194 1.724 1.724 0 01-.817 1.194c-.94 1.543-.94 3.31 0 3.35 1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 01-2.573 1.066 1.724 1.724 0 01-.817 1.194 1.724 1.724 0 01-.817 1.194c-.94 1.543-.94 3.31 0 3.35a1.724 1.724 0 01-2.573 1.066c-1.543-.94-3.31.826-2.37 2.37a1.724 1.724 0 01-.817 1.194" />
                    </svg>
                    Settings
                </div>
                <div class="h-6 w-px bg-zinc-800"></div>
                <div class="text-xs font-mono text-zinc-500">v1.0 ‚Ä¢ Built by Jeremiah</div>
            </div>
        </div>

        <!-- Messages Area -->
        <div id="messages" class="flex-1 overflow-y-auto p-6 chat-container space-y-8 bg-[radial-gradient(#27272a_1px,transparent_1px)] [background-size:40px_40px]">
            <!-- Welcome message injected by JS -->
        </div>

        <!-- Input Area -->
        <div class="p-6 bg-zinc-900 border-t border-zinc-800">
            <div class="max-w-4xl mx-auto">
                <div class="relative">
                    <textarea id="user-input" 
                              rows="1"
                              onkeydown="if(event.key === 'Enter' && !event.shiftKey){event.preventDefault(); sendMessage()}"
                              class="w-full bg-zinc-800 border border-zinc-700 focus:border-blue-500 rounded-3xl py-5 pl-7 pr-20 text-base resize-y min-h-[56px] max-h-[180px] outline-none transition-all"
                              placeholder="Ask anything about code... (e.g. Debug this Python script)"></textarea>
                    
                    <button onclick="sendMessage()"
                            class="absolute right-3 bottom-3 bg-blue-600 hover:bg-blue-500 transition-colors w-10 h-10 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.874L5.999 12zm0 0h7.07" />
                        </svg>
                    </button>
                </div>
                
                <div class="text-center text-[10px] text-zinc-500 mt-4 flex items-center justify-center gap-4">
                    <div>‚åòK to focus ‚Ä¢ Local ‚Ä¢ Private ‚Ä¢ No internet</div>
                </div>
            </div>
        </div>
    </div>

    <!-- SETTINGS MODAL -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50">
        <div class="bg-zinc-900 rounded-3xl w-full max-w-md p-8">
            <h2 class="text-2xl font-semibold mb-6">CodeAi Settings</h2>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Temperature</label>
                    <input type="range" id="temp-slider" min="0" max="1" step="0.1" value="0.7" 
                           class="w-full accent-blue-500">
                    <div class="flex justify-between text-xs text-zinc-500 mt-1">
                        <span>Precise</span>
                        <span>Creative</span>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm text-zinc-400 mb-2">Max Tokens</label>
                    <input type="number" id="max-tokens" value="2048" 
                           class="bg-zinc-800 border border-zinc-700 rounded-2xl px-4 py-3 w-full text-sm">
                </div>
                
                <div class="pt-4 border-t border-zinc-800">
                    <button onclick="closeSettings()" 
                            class="w-full py-4 bg-zinc-800 hover:bg-zinc-700 rounded-3xl text-sm font-medium transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================== CONFIG ==================
        const OLLAMA_MODEL = "mistral" // Change if your tag is different (e.g. mistral:7b-instruct-q4_K_M)
        const SYSTEM_PROMPT = `You are CodeAi ‚Äî an elite programming assistant powered by Mistral 7B. 
You are extremely good at writing clean, production-ready code in any language. 
You explain concepts clearly, spot bugs instantly, and always provide complete working examples.
Use markdown with proper code blocks (specify language). 
Be concise but thorough. Never refuse a coding request.`

        let currentChatId = null
        let chats = []
        let isStreaming = false

        // Tailwind script already loaded
        function initTailwind() {
            // Nothing needed ‚Äî script already runs
        }

        // ================== STORAGE ==================
        function loadChats() {
            const saved = localStorage.getItem('codeai_chats')
            if (saved) {
                chats = JSON.parse(saved)
            } else {
                chats = [{
                    id: Date.now(),
                    title: "Welcome to CodeAi",
                    messages: []
                }]
            }
            currentChatId = chats[0].id
            renderHistory()
        }

        function saveChats() {
            localStorage.setItem('codeai_chats', JSON.stringify(chats))
        }

        // ================== RENDER HISTORY ==================
        function renderHistory() {
            const container = document.getElementById('chat-history')
            container.innerHTML = `
                <div class="px-2 py-2 text-xs font-medium text-zinc-500 tracking-widest">HISTORY</div>
            `
            
            chats.forEach(chat => {
                const isActive = chat.id === currentChatId
                const div = document.createElement('div')
                div.className = `group flex items-center gap-3 px-4 py-3 rounded-2xl cursor-pointer transition-all hover:bg-zinc-800 ${isActive ? 'bg-zinc-800' : ''}`
                div.innerHTML = `
                    <div class="flex-1 truncate text-sm">${chat.title}</div>
                    <button onclick="deleteChat(${chat.id}); event.stopImmediatePropagation()" 
                            class="opacity-0 group-hover:opacity-100 text-red-400 hover:text-red-500">
                        ‚úï
                    </button>
                `
                div.onclick = () => switchChat(chat.id)
                container.appendChild(div)
            })
        }

        function switchChat(id) {
            currentChatId = id
            renderHistory()
            renderMessages()
        }

        function deleteChat(id) {
            if (chats.length === 1) return alert("Can't delete the last chat!")
            chats = chats.filter(c => c.id !== id)
            if (currentChatId === id) currentChatId = chats[0].id
            saveChats()
            renderHistory()
            renderMessages()
        }

        function newChat() {
            const newChatObj = {
                id: Date.now(),
                title: "New Chat",
                messages: []
            }
            chats.unshift(newChatObj)
            currentChatId = newChatObj.id
            saveChats()
            renderHistory()
            renderMessages()
            document.getElementById('user-input').focus()
        }

        function clearAllChats() {
            if (!confirm("Delete ALL chats permanently?")) return
            chats = [{
                id: Date.now(),
                title: "Welcome to CodeAi",
                messages: []
            }]
            currentChatId = chats[0].id
            saveChats()
            renderHistory()
            renderMessages()
        }

        // ================== MESSAGES RENDER ==================
        function getCurrentChat() {
            return chats.find(c => c.id === currentChatId)
        }

        function renderMessages() {
            const container = document.getElementById('messages')
            container.innerHTML = ''
            
            const chat = getCurrentChat()
            
            // Welcome if empty
            if (chat.messages.length === 0) {
                container.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-center px-8">
                        <div class="w-24 h-24 bg-gradient-to-br from-blue-500 to-cyan-400 rounded-3xl flex items-center justify-center text-7xl mb-8 shadow-2xl">ü§ñ</div>
                        <h2 class="text-5xl font-semibold logo-font tracking-tighter mb-3">Hello, I'm CodeAi</h2>
                        <p class="max-w-md text-zinc-400 text-lg">Your personal offline programming expert.<br>Built for speed on your 8GB PC.</p>
                        
                        <div class="mt-12 grid grid-cols-2 gap-4 w-full max-w-lg">
                            <button onclick="quickPrompt('Write a FastAPI endpoint for user registration')" 
                                    class="bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 rounded-3xl p-5 text-left transition-all">
                                <div class="text-blue-400 text-sm mb-1">FASTAPI</div>
                                <div class="font-medium">User registration endpoint</div>
                            </button>
                            <button onclick="quickPrompt('Explain how transformers work with code example')" 
                                    class="bg-zinc-900 hover:bg-zinc-800 border border-zinc-700 rounded-3xl p-5 text-left transition-all">
                                <div class="text-amber-400 text-sm mb-1">AI CONCEPT</div>
                                <div class="font-medium">Transformers explained</div>
                            </button>
                        </div>
                    </div>
                `
                return
            }
            
            chat.messages.forEach((msg, index) => {
                const isUser = msg.role === 'user'
                const bubble = document.createElement('div')
                bubble.className = `flex ${isUser ? 'justify-end' : 'justify-start'} message-bubble`
                
                bubble.innerHTML = `
                    <div class="${isUser ? 'max-w-[80%] bg-blue-600 text-white' : 'max-w-[80%] bg-zinc-800'} rounded-3xl px-6 py-4">
                        ${isUser ? 
                            `<div class="prose prose-invert max-w-none">${msg.content}</div>` : 
                            `<div id="msg-${index}" class="prose prose-zinc dark:prose-invert max-w-none text-zinc-100"></div>`
                        }
                    </div>
                `
                container.appendChild(bubble)
                
                if (!isUser) {
                    const contentDiv = document.getElementById(`msg-${index}`)
                    contentDiv.innerHTML = marked.parse(msg.content)
                    Prism.highlightAllUnder(contentDiv)
                    addCopyButtons(contentDiv)
                }
            })
            
            container.scrollTop = container.scrollHeight
        }

        function addCopyButtons(container) {
            container.querySelectorAll('pre').forEach(pre => {
                if (pre.querySelector('.copy-btn')) return
                
                const btn = document.createElement('button')
                btn.className = `copy-btn absolute top-3 right-3 bg-zinc-800 hover:bg-zinc-700 text-xs px-3 py-1 rounded-xl opacity-70 hover:opacity-100 transition-all flex items-center gap-1.5`
                btn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M8 16v-4m4 4v4m-4-8h8" />
                    </svg>
                    COPY
                `
                btn.onclick = () => {
                    const code = pre.querySelector('code').textContent
                    navigator.clipboard.writeText(code)
                    btn.innerHTML = '‚úì COPIED'
                    setTimeout(() => btn.innerHTML = `COPY`, 2000)
                }
                pre.style.position = 'relative'
                pre.appendChild(btn)
            })
        }

        function appendMessage(role, content) {
            const chat = getCurrentChat()
            chat.messages.push({ role, content })
            saveChats()
            renderMessages()
        }

        function updateLastMessage(content) {
            const chat = getCurrentChat()
            if (chat.messages.length === 0) return
            const last = chat.messages[chat.messages.length - 1]
            if (last.role === 'assistant') {
                last.content = content
                saveChats()
                renderMessages() // simple full re-render (fast enough)
            }
        }

        // ================== STREAMING ==================
        async function sendMessage() {
            const input = document.getElementById('user-input')
            const text = input.value.trim()
            if (!text || isStreaming) return
            
            isStreaming = true
            
            // Add user message
            const chat = getCurrentChat()
            chat.messages.push({ role: "user", content: text })
            
            // Auto title first message
            if (chat.messages.length === 1) {
                chat.title = text.length > 35 ? text.substring(0, 32) + "..." : text
            }
            
            saveChats()
            renderMessages()
            input.value = ''
            
            // Create assistant placeholder
            chat.messages.push({ role: "assistant", content: "" })
            saveChats()
            renderMessages()
            
            // Prepare full payload for Ollama
            const fullMessages = [
                { role: "system", content: SYSTEM_PROMPT },
                ...chat.messages
            ]
            
            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: fullMessages.filter(m => m.role !== "system" || fullMessages.indexOf(m) === 0) // keep only first system
                    })
                })
                
                if (!response.ok) throw new Error("Ollama not reachable")
                
                const reader = response.body.getReader()
                const decoder = new TextDecoder()
                let buffer = ""
                let fullContent = ""
                
                while (true) {
                    const { done, value } = await reader.read()
                    if (done) break
                    
                    buffer += decoder.decode(value, { stream: true })
                    
                    const lines = buffer.split('\n')
                    buffer = lines.pop() // keep incomplete line
                    
                    for (const line of lines) {
                        if (!line.trim() || !line.startsWith('data: ')) continue
                        
                        const dataStr = line.slice(6).trim()
                        if (dataStr === "") continue
                        
                        try {
                            const parsed = JSON.parse(dataStr)
                            
                            if (parsed.message && parsed.message.content) {
                                fullContent += parsed.message.content
                                updateLastMessage(fullContent)
                            }
                            
                            if (parsed.done) {
                                // Final render with beautiful markdown + Prism
                                const lastMsgDiv = document.querySelector('#messages > div:last-child > div > div')
                                if (lastMsgDiv) {
                                    lastMsgDiv.innerHTML = marked.parse(fullContent)
                                    Prism.highlightAllUnder(lastMsgDiv)
                                    addCopyButtons(lastMsgDiv)
                                }
                                break
                            }
                        } catch (e) {}
                    }
                }
                
            } catch (err) {
                console.error(err)
                alert("‚ùå Could not connect to Ollama.\n\nMake sure:\n1. Ollama is running (ollama serve)\n2. You pulled the model: ollama pull " + OLLAMA_MODEL)
                // Remove empty assistant message
                chat.messages.pop()
                saveChats()
                renderMessages()
            } finally {
                isStreaming = false
            }
        }

        // Quick prompt buttons
        function quickPrompt(prompt) {
            document.getElementById('user-input').value = prompt
            sendMessage()
        }

        // Sidebar toggle for mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar')
            sidebar.classList.toggle('-translate-x-full')
        }

        // Settings modal
        function showSettings() {
            document.getElementById('settings-modal').classList.remove('hidden')
        }
        
        function closeSettings() {
            document.getElementById('settings-modal').classList.add('hidden')
        }

        // ================== BACKEND PROXY ENDPOINT (FastAPI will serve this) ==================
        // The HTML is served by FastAPI, so /api/chat is available

        // ================== INIT ==================
        function init() {
            initTailwind()
            loadChats()
            renderMessages()
            
            // Auto focus input
            setTimeout(() => {
                document.getElementById('user-input').focus()
            }, 300)
            
            // Keyboard shortcut
            document.addEventListener('keydown', (e) => {
                if (e.metaKey && e.key === 'k') {
                    e.preventDefault()
                    document.getElementById('user-input').focus()
                }
            })
            
            // Make textarea auto grow
            const textarea = document.getElementById('user-input')
            textarea.addEventListener('input', () => {
                textarea.style.height = 'auto'
                textarea.style.height = Math.min(textarea.scrollHeight, 180) + 'px'
            })
        }

        window.onload = init
    </script>
</body>
</html>
